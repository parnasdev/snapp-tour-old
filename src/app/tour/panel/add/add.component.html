<div class="add-tour">
  <form [formGroup]="form">
    <div class="box-info-tour">
      <div class="info-tour-header">
        <div class="right">
          <label for="">{{tourType ? 'تور داخلی' : 'تور خارجی'}}</label>
          <h2 class="text-dark">اطلاعات تور</h2>
        </div>
        <div *ngIf="session.getRole() === 'Admin'" class="checkbox d-flex align-content-center">
          <input formControlName="offered" type="checkbox">
          <label for="">تور ویژه</label>
        </div>
        <div class="left d-flex align-items-center">
          <div *ngIf="session.checkPermission('Status')">
            <div class="selectdiv">
              <label>
                <select formControlName="status">
                  <option value="Show">انتشار</option>
                  <option value="Draft" selected>پیش نویس</option>
                  <option value="Accepted">تایید شده</option>
                  <option value="NotAccepted">عدم تایید</option>
                  <option value="Pending">در انتظار تایید</option>
                  <option value="Suspended">معلق شده/منقضی شده</option>
                  <option value="Completion">تکمیل شده</option>
                </select>
              </label>
            </div>
            <span class="required f-10" *ngIf="form.get('status')?.touched && form.get('status')?.invalid">
              این فیلد الزامی است
            </span>
            <div *ngIf="errorService.hasError('status')">
              <span class="text-danger">{{errorService.getError('status')}}</span>
            </div>
          </div>
          <div class="selectdiv me-2">
            <label>
              <select formControlName="defineTour" (change)="disableFields()">
                <option [value]="false">یکجا</option>
                <option [value]="true">باجزییات</option>
              </select>
            </label>
          </div>
        </div>
      </div>
      <div class="info-tour-body">
        <div class="top">
          <div class="item-info">
            <label for="">عنوان تور</label>
            <input formControlName="title" (change)="generateSlug()" type="text">
            <span class="required f-10" *ngIf="form.get('title')?.touched && form.get('title')?.invalid">
              این فیلد الزامی است
            </span>
            <div *ngIf="errorService.hasError('title')">
              <span class="text-danger">{{errorService.getError('title')}}</span>
            </div>
          </div>
          <div class="item-info-2">
            <div class="select-info">

              <label for="">شهر مبدا</label>

              <prs-select-city  [inCommingCity]="cities[0]" [cities]="cities"
                (citySelected)="getStCity($event)"></prs-select-city>

            </div>
            <div *ngIf="errorService.hasError('stCity_id')">
              <span class="text-danger">{{errorService.getError('stCity_id')}}</span>
            </div>
          </div>
          <div class="item-info">
            <div class="select-info">
              <label for="">شهر مقصد</label>

              <prs-select-city [hasHotel]="true" [cities]="cities"
                               (citySelected)="getEndCity($event)"></prs-select-city>
              <div *ngIf="errorService.hasError('endCity_id')">
                <span class="text-danger">{{errorService.getError('endCity_id')}}</span>
              </div>
            </div>
          </div>
          <div class="item-info-2">
            <div class="select-info">
              <label for="">تعداد شب</label>
              <select (change)="updatePackagePrices()" formControlName="nightNum" name="" id="">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
              </select>
              <div *ngIf="errorService.hasError('nightNum')">
                <span class="text-danger">{{errorService.getError('nightNum')}}</span>
              </div>
            </div>
          </div>
          <div class="item-info">
            <div class="select-info">
              <label for="">تعداد روز</label>
              <!--              <select formControlName="dayNum" name="" id="">-->
              <!--                <option [value]="+form.value.nightNum + 1">{{ +form.value.nightNum + 1 }}</option>-->
              <!--              </select>-->
              <div *ngIf="errorService.hasError('dayNum')">
                <span class="text-danger">{{errorService.getError('dayNum')}}</span>
              </div>
            </div>
            <span class="number-day-text">{{+form.value.nightNum + 1}}</span>
          </div>
          <div class="item-info">
            <label for="">نامک تور</label>
            <input *ngIf="isSlugGenerated" formControlName="slug" type="text">
            <span *ngIf="!isSlugGenerated">{{form.value.slug}}</span>
            <span class="required f-10" *ngIf="form.get('slug')?.touched && form.get('slug')?.invalid">
              این فیلد الزامی است
            </span>
            <div *ngIf="errorService.hasError('slug')">
              <span class="text-danger">{{errorService.getError('slug')}}</span>
            </div>
          </div>
          <div class="item-info">
            <label for="">تاریخ ورود به هتل</label>
            <mat-form-field class="example-full-width" appearance="fill">
              <input matInput [matDatepicker]="picker1" formControlName="stDate" [min]="minDate"
                     (click)="picker1.open()">
              <mat-datepicker #picker1></mat-datepicker>
            </mat-form-field>
            <div *ngIf="errorService.hasError('stDate')">
              <span class="text-danger">{{errorService.getError('stDate')}}</span>
            </div>
          </div>
          <div class="item-info">
            <label for="">تاریخ خروج از هتل</label>
            <mat-form-field class="example-full-width" appearance="fill">
              <input matInput formControlName="enDate" [matDatepicker]="picker2" [min]="minDate"
                     (click)="picker2.open()">
              <mat-datepicker #picker2></mat-datepicker>
            </mat-form-field>
            <div *ngIf="errorService.hasError('enDate')">
              <span class="text-danger">{{errorService.getError('enDate')}}</span>
            </div>
          </div>
          <div class="item-info">
            <label for="">تاریخ انقضا پکیج</label>
            <mat-form-field class="example-full-width" appearance="fill">
              <input matInput formControlName="expireDate" [matDatepicker]="picker3" [min]="minDate"
                     (click)="picker3.open()">
              <mat-datepicker #picker3></mat-datepicker>
            </mat-form-field>
            <div *ngIf="errorService.hasError('expireDate')">
              <span class="text-danger">{{errorService.getError('expireDate')}}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="p-list-fly">
      <div class="info-tour-header">
        <div class="right">
          <h2 class="text-dark">اطلاعات پرواز</h2>
        </div>
      </div>
      <div class="item-header">
        <span>#</span>
        <span>مسیر رفت-برگشت</span>
        <span>ایرلاین رفت-برگشت</span>
        <span>تاریخ رفت</span>
        <span>تاریخ برگشت</span>
        <span>قیمت بزرگسال</span>
        <span>قیمت کودک</span>
        <span>قیمت نوزاد</span>
        <span>ظرفیت</span>
      </div>
      <div class="info-tour-body-2">
        <div class="item" *ngFor="let item of transferRates">
          <input type="checkbox">
          <span>{{ item.origin.name }} - {{ item.destination.name }}</span>
          <span>{{ item.destination_transfer.name }} - {{ item.origin_transfer.name }}</span>
          <span>{{ this.calenderServices.convertDate(item.departure_date, 'fa') }}</span>
          <span>{{ this.calenderServices.convertDate(item.return_date, 'fa') }}</span>
          <span>{{ item.adl_price | sperator }}</span>
          <span>{{ item.chd_price | sperator }}</span>
          <span>{{ item.inf_price | sperator }}</span>
          <span>{{ item.capacity }}</span>
        </div>
      </div>
    </div>

    <div class="box-info-fly" *ngIf="form.value.defineTour == 'true' && !tourType">
      <div class="info-tour-header">
        <div class="right">
          <h2 class="text-dark">نرخ ارزها</h2>
        </div>
      </div>
      <div class="info-tour-body">
        <div class="top">
          <div class="item-info">
            <label for="">نرخ یورو(تومان)</label>
            <input (keyup)="updatePackagePrices()" formControlName="euroRate" type="text" mask="separator"
                   thousandSeparator=",">
          </div>
          <div class="item-info">
            <label for="">نرخ دلار(تومان)</label>
            <input (keyup)="updatePackagePrices()" formControlName="dollarRate" type="text" mask="separator"
                   thousandSeparator=",">
          </div>
          <div class="item-info">
            <label for="">نرخ درهم(تومان)</label>
            <input (keyup)="updatePackagePrices()" formControlName="AEDRate" type="text" mask="separator"
                   thousandSeparator=",">
          </div>

          <div>
            <p style="font-size: 12px !important;color: #ff0000;margin-top: 8px">نکته مهم: لطفا برای نمایش هر نرخ در
              باکس نرخ ها مقدار نرخ را وارد کنید.</p>
          </div>

        </div>
      </div>
    </div>

    <div class="box-info-fly" *ngIf="form.value.defineTour == 'true'">
      <div class="info-tour-header">
        <div class="right">
          <h2 class="text-dark">نرخ خدمات</h2>
        </div>
      </div>
      <div class="info-tour-body">
        <div class="top">
          <div class="item-info-services">
            <div class="box-services">
              <label for="">نرخ بیمه(تومان/ارزی)</label>
              <input (keyup)="updatePackagePrices()" formControlName="insuranceRate" type="text" mask="separator"
                     thousandSeparator=",">
            </div>
            <div class="selectdiv">
              <select (change)="updatePackagePrices()" formControlName="insurancePriceType">
                <option *ngIf="form.value.dollarRate" [value]="3">دلار</option>
                <option *ngIf="form.value.euroRate" [value]="2">یورو</option>
                <option *ngIf="form.value.AEDRate" [value]="4">درهم</option>
                <option [value]="1" selected>تومان</option>
              </select>
            </div>
          </div>
          <div class="item-info-services">
            <div class="box-services">
              <label for="">نرخ ترانسفر(تومان/ارزی)</label>
              <input (keyup)="updatePackagePrices()" formControlName="transferRate" type="text" mask="separator"
                     thousandSeparator=",">
            </div>
            <div class="selectdiv">
              <select (change)="updatePackagePrices()" formControlName="transferPriceType">
                <option *ngIf="form.value.dollarRate" [value]="3">دلار</option>
                <option *ngIf="form.value.euroRate" [value]="2">یورو</option>
                <option *ngIf="form.value.AEDRate" [value]="4">درهم</option>
                <option [value]="1">تومان</option>
              </select>
            </div>
          </div>
          <div class="item-info-services" *ngIf="!tourType">
            <div class="box-services">
              <label for="">نرخ ویزا(تومان/ارزی)</label>
              <input (keyup)="updatePackagePrices()" formControlName="visaRate" type="text" mask="separator"
                     thousandSeparator=",">
            </div>
            <div class="selectdiv">
              <select (change)="updatePackagePrices()" formControlName="visaPriceType">
                <option *ngIf="form.value.dollarRate" [value]="3">دلار</option>
                <option *ngIf="form.value.euroRate" [value]="2">یورو</option>
                <option *ngIf="form.value.AEDRate" [value]="4">درهم</option>
                <option [value]="1">تومان</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- <div class="box-info-fly" *ngIf="form.value.defineTour == 'true'">
      <div class="info-tour-header">
        <div class="right">
          <h2 class="text-dark">نرخ پرواز</h2>
        </div>
      </div>
      <div class="info-tour-body">
        <div class="top">

          <div class="item-info-services">
            <div class="box-services w-100">
              <label for="">نرخ پرواز بزرگسال(تومان)</label>
              <input (keyup)="setADLRate($event)" formControlName="ADLFlightRate" type="text" mask="separator"
                     thousandSeparator=",">
              <div *ngIf="errorService.hasError('ADLFlightRate')">
                <span class="text-danger">{{errorService.getError('ADLFlightRate')}}</span>
              </div>
            </div>
          </div>

          <div class="item-info-services">
            <div class="box-services w-100">
              <label for="">نرخ پرواز کودک(تومان)</label>
              <input (keyup)="setCnbRate($event)" formControlName="CHDFlightRate" type="text" mask="separator"
                     thousandSeparator=",">
              <div *ngIf="errorService.hasError('CHDFlightRate')">
                <span class="text-danger">{{errorService.getError('CHDFlightRate')}}</span>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div> -->

    <div class="box-info-package">
      <div class="info-tour-header">
        <div class="right">
          <h2 class="text-dark">اطلاعات پکیج</h2>
        </div>
        <div class="left">
          <div class="selectdiv me-2">
            <label>
              <select (change)="sortPackages($event)">
                <option value="null">مرتب سازی بر اساس:</option>
                <option [value]="1">ارزان ترین قیمت</option>
                <option [value]="2">ستاره</option>
              </select>
            </label>
          </div>
        </div>
      </div>
      <div class="info-tour-body p-0">
        <!-- <div class="change-price-box">
          <span>تغییر گروهی قیمت ها</span>
          <input type="text">
        </div> -->
        <div class="change-price-box" *ngIf="form.value.defineTour == 'false' && !tourType">
          <span>نرخ پکیج و قیمت پرواز</span>
          <div style="margin-right: 16px" class="d-flex align-items-center w-100 mr-5">
            <select [formControl]="ratePricesFC" (change)="changeRateForPackages($event)">
              <option [value]="3">دلار</option>
              <option [value]="2">یورو</option>
              <option [value]="4">درهم</option>
              <option [value]="1">تومان</option>
            </select>

            <div class="w-50" *ngIf="checkPackageRate()">
              <input (keyup)="setADLRatePrice($event)" formControlName="ADLFlightRate"
                     placeholder="قیمت پرواز بزرگسال به تومان" type="text" mask="separator" thousandSeparator=",">
              <div *ngIf="errorService.hasError('ADLFlightRate')">
                <span class="text-danger">{{errorService.getError('ADLFlightRate')}}</span>
              </div>
              <input (keyup)="setCnbRatePrice($event)" formControlName="CHDFlightRate"
                     placeholder="قیمت پرواز کودک به تومان" type="text" mask="separator" thousandSeparator=",">
              <div *ngIf="errorService.hasError('CHDFlightRate')">
                <span class="text-danger">{{errorService.getError('CHDFlightRate')}}</span>
              </div>
            </div>
          </div>
        </div>
        <!--            local tour-->
        <div class="w-100 d-flex flex-column mobile-package">
          <div class="header-box" *ngIf="tourType">
            <div class="package-item">#</div>
            <div class="package-item">نام هتل</div>
            <div class="package-item">خدمات</div>
            <div class="package-item">
              دو تخته(هرنفر)
              <br>
              ظرفیت
            </div>
            <div class="package-item">
              سه تخته(هرنفر)
              <br>
              ظرفیت
            </div>
            <div class="package-item">
              چهار تخته(هرنفر)
              <br>
              ظرفیت
            </div>
            <div class="package-item">سن کودک</div>
            <div class="package-item" *ngIf="form.value.defineTour == 'true'">نرخ بزرگسال</div>
            <div class="package-item">آفر ویژه</div>
            <div></div>
          </div>
          <!--            foreign tour-->
          <div class="header-box-two" *ngIf="!tourType">
            <div class="package-item">#</div>
            <div class="package-item">نام هتل</div>
            <div class="package-item">{{ form.value.defineTour == 'true' ? 'نرخ / خدمات' : 'خدمات'}}</div>
            <div class="package-item">
              دو تخته(هرنفر)
              <br>
              ظرفیت
            </div>
            <div class="package-item">
              یک تخته(هرنفر)
              <br>
              ظرفیت
            </div>
            <div class="package-item">
              کودک با تخت(هرنفر)
              <br>
              ظرفیت
            </div>
            <!-- <div class="package-item">کودک بدون تخت</div> -->
            <div class="package-item">سن کودک</div>
            <div class="package-item" *ngIf="form.value.defineTour == 'true'">نرخ بزرگسال</div>
            <div class="package-item">آفر ویژه</div>
            <div></div>
          </div>
          <form [formGroup]="form" class="example-list" formArrayName="packages" action="" cdkDropList
                (cdkDropListDropped)="drop($event)">
            <div class="body-box example-box" *ngFor="let tour of ToursForm.controls; let i = index" cdkDrag
                 [formGroupName]="i">
              <div class="package-item id-package">
                <div class="icon-from-to">
                  <i class="icon-up-open"></i>
                  <i class="icon-down-open"></i>
                </div>
              </div>
              <div class="package-item">
                <!--              <select name="" id="" formControlName="hotel_id">-->
                <!--                <option *ngFor="let hotel of hotels"-->
                <!--                        [value]="hotel.id">{{tourType ? hotel.name : hotel.nameEn}}</option>-->
                <!--              </select>-->
                <prs-select-hotel [hotels]="hotels" [callHotel]="false" [type]="tourType" [isAdmin]="true"
                                  (hotelSelected)="hotelChange($event,i)"></prs-select-hotel>
                <div class="parent-icon under-package d-flex align-items-center">
                  <i class="icon-star text-warning" *ngFor="let star of getStars(i)"></i>
                </div>
              </div>
              <div class="package-item">
                <div class="d-flex align-items-center w-100 parent-box-rate">
                  <div class="package-item rate-width" *ngIf="form.value.defineTour == 'true' && !tourType">
                    <select (change)="updatePackagePrices()" formControlName="rate">
                      <option *ngIf="form.value.dollarRate" [value]="3">دلار</option>
                      <option *ngIf="form.value.euroRate" [value]="2">یورو</option>
                      <option *ngIf="form.value.AEDRate" [value]="4">درهم</option>
                      <option [value]="1">تومان</option>
                    </select>
                  </div>
                  <div class="package-item service-width">
                    <select name="" id="" formControlName="services">
                      <option *ngFor="let service of services" [value]="service.id">{{service.name}}</option>
                    </select>
                  </div>
                </div>
              </div>

              <!--            local tour-->
              <ng-template class="body-local" [ngIf]="tourType">
                <div class="package-item">
                  <input placeholder="قیمت (تومان)" (keyup)="calculatePrice('twin', $event, true, i)" type="text"
                         formControlName="twin"
                         mask="separator" thousandSeparator=",">
                  <div class="under-package-text d-flex align-items-center"
                       *ngIf="form.value.defineTour == 'true' && form.get('packages')?.value[i].twin > 0">
                    <p>{{ getData(i).twinRate.value | sperator }}</p>

                  </div>
                  <input type="text" formControlName="twinCapacity" placeholder="موجودی" mask="separator"
                         thousandSeparator=",">
                </div>
                <div class="package-item">
                  <input placeholder="قیمت (تومان)" (keyup)="calculatePrice('triple', $event, true, i)" type="text"
                         formControlName="triple"
                         mask="separator" thousandSeparator=",">
                  <div class="under-package-text"
                       *ngIf="form.value.defineTour == 'true' && form.get('packages')?.value[i].triple > 0">
                    <p>{{ getData(i).tripleRate.value | sperator }}</p>
                  </div>
                  <input type="text" placeholder="موجودی" formControlName="tripleCapacity" mask="separator"
                         thousandSeparator=",">
                </div>
                <div class="package-item">
                  <input placeholder="قیمت (تومان)" (keyup)="calculatePrice('quad', $event, true, i)" type="text"
                         formControlName="quad"
                         mask="separator" thousandSeparator=",">
                  <div class="under-package-text"
                       *ngIf="form.value.defineTour == 'true' && form.get('packages')?.value[i].quad > 0">
                    <p>{{ getData(i).quadRate.value | sperator }}</p>
                  </div>
                  <input type="text" placeholder="موجودی" formControlName="quadCapacity" mask="separator"
                         thousandSeparator=",">
                </div>
                <div class="package-item">
                  <input type="text" formControlName="age">
                </div>
                <div class="package-item" *ngIf="form.value.defineTour == 'true'">
                  <input (keyup)="updatePackagePrices()" type="text" formControlName="ADLRate" mask="separator"
                         thousandSeparator=",">
                </div>
                <div class="package-item d-flex flex-row">
                  <input formControlName="offered" class="offer-checkbox" type="checkbox">
                  <!-- <input formControlName="pool" class="offer-checkbox" type="checkbox"> -->
                </div>
                <div style="flex-direction: row !important;" class="package-item">
                  <i class="icon-trash text-danger" (click)="removePackage(i)"></i>
                  <img src="assets/img/FAQ.svg" width="18" class="ms-2" (click)="openRoomPopup(i)">
                </div>
              </ng-template>
              <!--            foreign tour-->
              <ng-template class="body-foreign" [ngIf]="!tourType">
                <div class="package-item">
                  <input placeholder="قیمت (تومان)" (keyup)="calculatePrice('twin', $event, true, i)" type="text"
                         formControlName="twin"
                         mask="separator" thousandSeparator=",">
                  <div class="under-package-text"
                       *ngIf="form.value.defineTour == 'true' && form.get('packages')?.value[i].twin > 0">
                    <p>{{ getData(i).twinRate.value | sperator }}</p>
                  </div>
                  <input type="text" formControlName="twinCapacity" mask="separator" placeholder="موجودی"
                         thousandSeparator=",">

                </div>
                <div class="package-item">
                  <input placeholder="قیمت (تومان)" (keyup)="calculatePrice('single', $event, true, i)" type="text"
                         formControlName="single"
                         mask="separator" thousandSeparator=",">
                  <div class="under-package-text"
                       *ngIf="form.value.defineTour == 'true' && form.get('packages')?.value[i].single > 0">
                    <p>{{ getData(i).singleRate.value | sperator }}</p>
                  </div>
                  <input type="text" placeholder="موجودی" formControlName="singleCapacity" mask="separator"
                         thousandSeparator=",">

                </div>
                <div class="package-item">
                  <input (keyup)="calculatePrice('cwb', $event, false, i)" placeholder="قیمت (تومان)" type="text"
                         formControlName="cwb"
                         mask="separator" thousandSeparator=",">
                  <div class="under-package-text"
                       *ngIf="form.value.defineTour == 'true' && form.get('packages')?.value[i].cwb > 0">
                    <p>{{ getData(i).cwbRate.value | sperator }}</p>
                  </div>
                  <input type="text" placeholder="موجودی" formControlName="cwbCapacity" mask="separator"
                         thousandSeparator=",">

                </div>
                <!-- <div class="package-item">
                  <input type="text" formControlName="cnb" mask="separator" thousandSeparator=",">
                </div> -->
                <div class="package-item">
                  <input placeholder="سن کودک" type="text" formControlName="age">
                </div>
                <div class="package-item" *ngIf="form.value.defineTour == 'true'">
                  <input (keyup)="updatePackagePrices()" type="text" formControlName="ADLRate" mask="separator"
                         thousandSeparator=",">
                </div>
                <div class="package-item d-flex flex-row">
                  <input formControlName="offered" class="offer-checkbox" type="checkbox">
                  <!-- <input formControlName="pool" class="offer-checkbox" type="checkbox"> -->
                </div>
                <div style="flex-direction: row !important;" class="package-item">
                  <i class="icon-trash text-danger" (click)="removePackage(i)"></i>
                  <img src="assets/img/FAQ.svg" width="18" (click)="openRoomPopup(i)">
                </div>
              </ng-template>

            </div>
          </form>
        </div>


        <div class="package-item">
          <a (click)="addRow(0)" class="btn-add-tour-fix">
            <i class="icon-plus-squared-alt"></i>
            <span>اضافه</span>
          </a>
        </div>
      </div>

    </div>

    <div class="box-details-tour">
      <div class="info-tour-header">
        <div class="right">
          <h2 class="text-dark">جزییات تور</h2>
        </div>
      </div>
      <div class="details-body-tour">
        <div class="textarea">
          <textarea formControlName="services" name="" cols="30" rows="10" placeholder="خدمات"></textarea>
          <div *ngIf="errorService.hasError('services')">
            <span class="text-danger">{{errorService.getError('services')}}</span>
          </div>
          <textarea formControlName="documents" name="" cols="30" rows="10" placeholder="مدارک مورد نیاز"></textarea>
          <div *ngIf="errorService.hasError('documents')">
            <span class="text-danger">{{errorService.getError('documents')}}</span>
          </div>
          <textarea formControlName="description" name="" cols="30" rows="10" placeholder="توضیحات تکمیلی"></textarea>
          <div *ngIf="errorService.hasError('description')">
            <span class="text-danger">{{errorService.getError('description')}}</span>
          </div>
        </div>
        <prs-btn style="width: 15%;" class="btn-submit-tour w-100-mobi" [background]="'blue'" (click)="submit()"
                 [isLoading]="isLoading" [label]="'ثبت تور'"></prs-btn>
      </div>
    </div>
  </form>

</div>
